Теперь, давайте запустим приложение и создадим для него ингресс, и получим доступ к приложению через балансировщик. 

**Создаем файл** deployment.yaml. 

Это файл с описанием деплоймента приложения, хорошо нам знакомый по прошлым сценариям. 

И **создаем файл** service.yaml с описанием сервиса. Также хорошо нам знакомый по прошлым сценариям. 

И теперь **создадим ингресс ямл**  для нашего приложения. 

Как мы можем видеть тут простейшее описание объекта типа Ingress.  аннотация kubernetes.io/ingress.class: "nginx" сообщает, что изменения в этом объекте слушает nginx-ingress-controller. А правила маршрутизации в атрибуте rules спецификации довольно просты: все запросы которые приходят на балансировщик проксировать на 9000 порт сервиса hello-service. 

**Применяем все манифесты.** 

**Во втором терминале** можем наблюдать за тем, как создаются *поды*. 
Дождемся, пока *деплоймент* раскатится - т.е. когда все *поды* станут в статусе Running.

Давайте сделаем запросы к nginx-у и посмотрим, действительно ли он маршрутизирует запросы к нашему сервису. 

**Делаем запрос с помощью команды curl на слэш вершн**

И в ответе видим версию нашего сервиса hello-service

**А если сделать запрос с помощью команды curl на слэш **

В ответ увидим стандартное hello from

Давайте поменяем правила маршрутизации так, чтобы все запросы к балансировщику на локейшене `/myapp/` проксировались  в `hello-service` на `9000` порт.  При этом надо сделать так, чтобы локейшн переписывался, т.е. чтобы запросы в сервис приходили без префика /myapp. Т.е. чтобы запросы типа `/myapp/version` приходили в hello-service c  локейшном `/version`. Для этого нам нужно переписывать запрос. В самом nginx такая функциональность существует. Это делается с помощью директивы rewrite-target. Но в спецификации объекта Ingress никаких директив не предусмотрено. 

Для того, чтобы передать ингресс контроллеру настройки этой директивы через объект Ingress, используются аннотации.  Для директивы rewrite-target нужно использовать *аннотацию* nginx.ingress.kubernetes.io/rewrite-target. Эту аннотацию читает ингресс-контроллер и соответствующим образом применяет. 

В нашем случае директива работает так. Rewrite-target: /$2 означает - заменить локейшн на 2-ую группу из регулярного выражения `/myapp($|/)(.*)` - т.е. фактически это значит, что нужно отрезать часть `/myapp($|/)`. Это то, что нам нужно. 

**Обновим манифест ингресса:** 

**И применим манифест:** 

Ингресс контроллер обновил конфигурацию nginx, теперь, **обращаясь по урлу `/`** балансировщик будет отдавать 404-ую ошибку (не найдено): 

**Обращаясь по урлу `/myapp/version`** , балансировщик будет отдавать версию сервиса `hello-service`. 

**А по `/myapp/` :**

будет отдавать стандартное hello from.

Также мы с вами можем посмотреть, как выглядит конфигурация балансировщика nginx, с помощью команды kubectl exec и вывести конфиг /etc/nginx/nginx.conf

**Запускаем команду**

Видим с вами настройки нашего локейшна уже непосредственно в самом балансирощике.

Итак мы с вами посмотрели, как работает ингресс-контроллер, и как с его помощью можно давать доступ к сервисам снаружи. 



